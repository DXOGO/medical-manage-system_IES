

<!DOCTYPE html>
<html lang="en">
<head>
  
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Sinais Vitais</title>

  <!-- Google Font: Source Sans Pro -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="../../plugins/fontawesome-free/css/all.min.css">
  <!-- uPlot -->
  <link rel="stylesheet" href="../../plugins/uplot/uPlot.min.css">
  <!-- Theme style -->
  <link rel="stylesheet" href="../../css/adminlte.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.2/sockjs.min.js" integrity="sha512-ayb5R/nKQ3fgNrQdYynCti/n+GD0ybAhd3ACExcYvOR2J1o3HebiAe/P0oZDx5qwB+xkxuKG6Nc0AFTsPT/JDQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js" integrity="sha512-iKDtgDyTHjAitUDdLljGhenhPwrbBfqTKWO1mkhSFH3A7blITC9MhYon6SjnMhp4o0rADGw9yAC6EW4t5a4K3g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.js" integrity="sha512-tL4PIUsPy+Rks1go4kQG8M8/ItpRMvKnbBjQm4d2DQnFwgcBYRRN00QdyQnWSCwNMsoY/MfJY8nHp2CzlNdtZA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>


</head>
<body  onload ="connect()" class="hold-transition sidebar-mini">
  <a href="../internados"><i style="border: solid black;
    border-width: 0 3px 3px 0;
    display: inline-block;
    padding: 3px; transform: rotate(135deg);
    -webkit-transform: rotate(135deg); margin-left: 2rem; margin-top: 3rem; height: 30px; width: 30px"></i></a>
  <!-- Content Wrapper. Contains page content -->
  <div class="container emp-profile" style="margin-top: 50px;">
    <form method="post">
        <div class="row">
            <div class="col-md-4">
               
            </div>
            <div class="col-md-6">
                <div class="profile-head">
                            <h3 style="font-weight: 550;" id="pacname">
                                
                            </h3>
                            <h5 id="razao">
                                
                            </h5>
                            <div class="row" style="margin-top: 25px">
                                <div class="col-md-8">
                                    <div class="tab-content profile-tab" id="myTabContent">
                                        <div class="tab-pane fade show active" id="home" role="tabpanel" aria-labelledby="home-tab">
                                          <div class="row state-row"  >
                                            <div class="col-md-6">
                                                <label>Estado</label>
                                            </div>
                                            <div class="col-md-6">
                                                <p id="estado"></p>
                                            </div>
                                        </div>
                                          <div class="row">
                                            <div class="col-md-6">
                                                <label>Cartão de Cidadão</label>
                                            </div>
                                            <div class="col-md-6">
                                                <p id="cc"></p>
                                            </div>
                                        </div>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <label>Email</label>
                                                </div>
                                                <div class="col-md-6">
                                                    <p id="mail"></p>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <label>Número de telemóvel</label>
                                                </div>  
                                                <div class="col-md-6">
                                                    <p id="numtel"></p>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <label>Morada</label>
                                                </div>
                                                <div class="col-md-6">
                                                    <p id="address"></p>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <label>Data de Nascimento</label>
                                                </div>
                                                <div class="col-md-6">
                                                    <p id="datanasc"></p>
                                                </div>
                                            </div>                                           
                                             <div class="row">
                                              <div class="col-md-6">
                                                  <label>Data de internamento</label>
                                              </div>
                                              <div class="col-md-6">
                                                  <p id="datainter"></p>
                                              </div>
                                          </div>
                                          
                                        <div class="row">
                                        <div class="col-md-6">
                                            <label>Quarto</label>
                                        </div>
                                        <div class="col-md-6">
                                            <p id="quarto"></p>
                                        </div>
                                  </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                </div>
            </div>
        </div>
    </form>           
  </div>


    
    <!-- Main content -->
    <section class="content">
        
      <div class="container-fluid">
          
          <!-- LINE CHART -->
          <div class="card card-info">
              <div class="card-header">
                  <h3 class="card-title">Line Chart</h3>
                  
                  <div class="card-tools">
                      <button type="button" class="btn btn-tool" data-card-widget="collapse">
                          <i class="fas fa-minus"></i>
                        </button>
                        <button type="button" class="btn btn-tool" data-card-widget="remove">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
    <div class="card-body">
        <div class="chart">
            <div id="lineChart" style="min-height: 250px; height: 250px; max-height: 250px; max-width: 100%;"></div>
        </div>
    </div>
    <!-- /.card-body -->
</div>
<!-- /.card -->


<!-- /.card-body -->
</div>
<!-- /.card -->

<div class="row">
  <div  class="col-lg-4 col-6">
    <!-- small card -->
    <div class="small-box bg-info">
      <div class="inner">
        <h3 class="sensor" id="1">150</h3>

        <p>Oxigénio</p>
      </div>
      <div class="icon">
        <i class="fas fa-lungs"></i>
      </div>
      
    </div>
  </div>
  <!-- ./col -->
  <div class="col-lg-4 col-6">
    <!-- small card -->
    <div class="small-box bg-danger">
      <div class="inner">
        <h3 class="sensor" id="2" >null</h3>

        <p>Temperatura</p>
      </div>
      <div class="icon">
        <i class="fas fa-temperature-low"></i>
      </div>
      
    </div>
  </div>
  <!-- ./col -->
  <div id="yourDiv" class="col-lg-4 col-6">
    <!-- small card -->
    <div class="small-box bg-warning">
      <div class="inner">
        <h3 id="3" class="sensor" >44/44</h3>

        <p>Pressão Arterial</p>
      </div>
      <div class="icon">
        <i class="fas fa-stethoscope"></i>
      </div>
      
    </div>
  </div>
  
</div>

</div><!-- /.container-fluid -->
</section>
<!-- /.content -->

<!-- jQuery -->
<script src="../../plugins/jquery/jquery.min.js"></script>
<!-- Bootstrap 4 -->
<script src="../../plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
<!-- uPlot -->
<script src="../../plugins/uplot/uPlot.iife.min.js"></script>
<!-- AdminLTE App -->
<script src="../../js/adminlte.min.js"></script>
<!-- AdminLTE for demo purposes -->
<script src="../../js/demo.js"></script>
<!-- Page specific script -->

<script>
$( document ).ready(function() {
async function getData(url){
    const response = await fetch(url);
    var data = await response.json();
    
    show_data(data);
  function reload(){
    var container = document.getElementById("yourDiv");
    var content = container.innerHTML;
    container.innerHTML= content; 
    
   //this line is to watch the result in console , you can remove it later	
    console.log("Refreshed"); 
}
}
  const queryString = window.location.href.toString();
  
  const newurl = queryString.replace("6767", "6767/api");

  //max is
  
  //const id = urlParams.get('id')
  const id=queryString.split("/")[queryString.split("/").length-1];

  getData(newurl);

//upon document load
  //should add data-id to the class with the class sensor
  //get elements that use class 
  //change by class sense and #id
  // recebo o id no url
  // vou à tag html com a classe sensor
  //adicionar a classe data-id='id'
  //TODO change later the 1 to id
 /*  $( ".sensor" ).data( "data-id",1 );
  $('div').attr('data-id', 1);


  var igot = $(this).data('id');
  $(".sensor #deid").val( igot ); 


  */
 
 var c = 0;
 
 function show_data(data){
  var result = JSON.stringify(data);
  var mydata = JSON.parse(result);
  //get first key
  var fk =Object.keys(mydata)[0];
  var pacinfo= JSON.stringify(mydata[fk][1]["pessoa"]);
  var jsonedpacinfo =JSON.parse(pacinfo);
  
  var tab = ``;
  tab+= mydata[fk][0]["temperatura"];
  document.getElementById("2").innerHTML = tab; //temp
  var tab = ``;
  tab+= mydata[fk][0]["oxigenio"];
  document.getElementById("1").innerHTML = tab; //oxi
  var tab = ``;
  tab+= mydata[fk][0]["pressaoarterial"][0];
  tab+="|";
  tab+= mydata[fk][0]["pressaoarterial"][1];

  document.getElementById("3").innerHTML = tab; //pressa
  var tab = ``;
  tab+= mydata[fk][0]["quartocama"];
  document.getElementById("quarto").innerHTML = tab; 
  var tab = ``;
  tab+="Razão de Internamento - "
  tab+= mydata[fk][0]["razaointernamento"];
  document.getElementById("razao").innerHTML = tab; //temp
  var tab = ``;
  tab+= mydata[fk][0]["estado"];
  document.getElementById("estado").innerHTML = tab; //temp
  var state= mydata[fk][0]["estado"];

  var tab = ``;
  tab+= mydata[fk][0]["dataadmissao"];
  document.getElementById("datainter").innerHTML = tab;
 /*  var tab = ``;
  tab+= mydata[fk]["internamento"][0]["datasaida"];
  document.getElementById("datas").innerHTML = tab; */
 // camaquarto razao estado

 //pacdata
 

  var tab = ``;
  tab+= jsonedpacinfo["name"];
  document.getElementById("pacname").innerHTML = tab;
  var tab = ``;
  tab+= jsonedpacinfo["name"];
  document.getElementById("pacname").innerHTML = tab;
  var tab = ``;
  tab+= id;
  
  document.getElementById("cc").innerHTML = tab;
  var tab = ``;
  tab+= jsonedpacinfo["telemovel"];
  document.getElementById("numtel").innerHTML = tab;
  var tab = ``;
  tab+= jsonedpacinfo["morada"];
  document.getElementById("address").innerHTML = tab;
  var tab = ``;
  tab+= jsonedpacinfo["datanascimento"];
  document.getElementById("datanasc").innerHTML = tab;
  var tab = ``;
  tab+= jsonedpacinfo["email"];
  document.getElementById("mail").innerHTML = tab;
/*   var list;
  
  
  tab+='|';
  tab+= result[7][1][1];
  
  
  tab = ``;
  tab+= result[3][1];
  document.getElementById("1").innerHTML = tab; //oxi
  tab = ``;
  
  tab+= result[2][1];
  document.getElementById("2").innerHTML = tab; //temp */

  //change color of state according to state

  if(state=="estável"){
    $('.state-row').addClass("bg-success");
    
  }else if(state=="coma"){
    $('.state-row').addClass("bg-danger");
    
  }else{
    $('.state-row').addClass("bg-warning");
    
  }
  
}



console.log("control");

}); 
</script>

<script>
function sortminmax(array) {
  let sortarray=[...array].sort();
  return [sortarray[0],sortarray.at(-1)];
}

var finaltimes=[];
var counterdebeat=0;
var insidec=0;
let lineChart;
var states=[0,0,0,0]
var finalvalues=[];

var stompClient = null;
            
           /*  function setConnected(connected) {
                document.getElementById('connect').disabled = connected;
                document.getElementById('disconnect').disabled = !connected;
                document.getElementById('conversationDiv').style.visibility 
                  = connected ? 'visible' : 'hidden';
                document.getElementById('response').innerHTML = '';
            } */           
            const queryString = window.location.href.toString();

//const id = urlParams.get('id')
            const id=queryString.split("/")[queryString.split("/").length-1];
            function connect() {
                var socket = new SockJS('/ws');
                stompClient = Stomp.over(socket);  
                stompClient.connect({}, function(frame) {
                    console.log('Connected: ' + frame);
                    stompClient.subscribe('/topic/messages', function(messageOutput) {
                        console.log(messageOutput.body);
                        showMessageOutput(messageOutput.body);
                    });
                });
            }
            
            function disconnect() {
                if(stompClient != null) {
                    stompClient.disconnect();
                }
                setConnected(false);
                console.log("Disconnected");
            }
            
            
            
            function showMessageOutput(messageOutput) {
              var t= messageOutput.toString();
              var result = JSON.stringify(t);
              var dados = JSON.parse(result);
              //get first key
              //get cc seria
              console.log(dados.split('cc')[1].split(':')[1].split('\}')[0].trim());
              if(dados.split('cc')[1].split(':')[1].split('\}')[0].trim()==id){

                if (dados.split(',')[0].split(':')[1].trim() == "\"temp\""){
                  var fina= dados.split(',')[1].split(':')[1];
                  
                  document.getElementById('2').textContent=fina;
                  fina= parseFloat(fina);

                  if (fina<38 || fina >=36.5){
                    states[1]=0;
                  }else if(fina<=38.5 || fina >=35.5){
                    states[1]=1;
                  }else{
                    states[1]=2;
                  }
                }else if(dados.split(',')[0].split(':')[1].trim() == "\"press\""){
                  
                  var fina = dados.split(',')[1].split(':')[1].split("\[")[1];
                  var first = fina
                  fina+="|";
                  fina+=dados.split('[')[1].split(',')[1].split("\]")[0];
                  document.getElementById('3').textContent=fina;
                  var second =dados.split('[')[1].split(',')[1].split("\]")[0];
                  first= parseFloat(first);
                  second= parseFloat(second);
                  if(second>105 || first>160   ){
                    states[2]=2;
                  }else if((first<=140 && second>=105) || (first<=100 && second>60)){
                    states[2]=0;
                  }else{
                    states[2]=1;
                  } //stable

                  
                } else if(dados.split(',')[0].split(':')[1].trim() == "\"oxi\"") {

                  var fina= dados.split(',')[1].split(':')[1];
                  
                  console.log("si")
                  document.getElementById('1').textContent=fina;
                  fina= parseFloat(fina);
                  if (fina>95){
                    states[3]=0;
                  }else if(fina<90){
                    states[3]=2;
                  }else{
                    states[3]=1;
                  }

                  
                }else{
                  var timedata=dados.split('\[')[1].split('\]')[0].split(',').slice(0,250);
                  var valuedata=dados.split('\[')[1].split('\]')[0].split(',').slice(250,500);
                  timedata.forEach(element => {
                    var e= element.toString().trim();
                    finaltimes.push(parseFloat(e));
                    
                  });
                  valuedata.forEach(element => {
                    var e=element.toString().trim();
                    
                    finalvalues.push(parseFloat(e));
                  });
                  
                  var graphdata =[finaltimes,finalvalues];
                console.log("grafisse",graphdata);
                
                function getSize(elementId) {
                  return {
                    width: document.getElementById(elementId).offsetWidth,
                    height: document.getElementById(elementId).offsetHeight,
                  }
                }
                //data can be gotten from a js fuction
                
                
                var optsLineChart = {
                  ... getSize('lineChart'),
                  scales: {
                    x: {
                      time: false,
                    },
                    y: {
                    },
                  },
                  series: [
                    {},
                    {
                      fill: 'transparent',
                      width: 5,
                      stroke: 'rgba(60,141,188,1)',
                    },
                    
                  ],
                };
                if (!lineChart) {
                  lineChart = new uPlot(optsLineChart, graphdata, document.getElementById('lineChart'));
                }else{
                  //nunca vai correr sou burro fdd
                  counterdebeat=counterdebeat+1;
                  console.log(counterdebeat);
                  if(counterdebeat>10){
                    graphdata[1]=graphdata[1].slice(250*insidec);
                    graphdata[0]=graphdata[0].slice(250*insidec);
                    insidec=insidec+1;
                  }
                  //lineChart = uPlot(optsLineChart,graphdata,document.getElementById('lineChart'));
                  let vals=sortminmax(graphdata[0]);
                  lineChart.setData(graphdata, true);
                  lineChart.setScale(x,{min:vals[0], max:vals[1]});
                  lineChart.redraw(true,true);
                }
                window.addEventListener("resize", e => {
                  lineChart.setSize(getSize('lineChart'));
                  
                });
                
              }
              var max=-123
              max= Math.max(...states);
              if($('.state-row').hasClass('bg-success')){
                  $('.state-row').removeClass('bg-success')
                }else if($('.state-row').hasClass('bg-danger')){
                  $('.state-row').removeClass('bg-danger')
                }else if($('.state-row').hasClass('bg-warning')){
                  $('.state-row').removeClass('bg-warning')
                }
              if (max==0){
                document.getElementById("estado").innerHTML="estável";
                $('.state-row').addClass("bg-success");

              }else if (max==1){
                document.getElementById("estado").innerHTML="grave";

                $('.state-row').addClass("bg-warning");

              }else if(max==2){
                document.getElementById("estado").innerHTML="critico";
                $('.state-row').addClass("bg-danger");

              }

            }
              
            }
            
            
          </script>
          
</body>
</html>